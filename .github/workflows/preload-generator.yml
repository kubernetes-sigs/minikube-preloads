name: Preload Assets

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to upload assets to (default: latest release)"
        required: false
        default: "latest"
      minikube_ref:
        description: "minikube git ref to build from (default: HEAD)"
        required: false
        default: "HEAD"
      limit:
        description: "Value for --limit passed to preload-generator (default: 3)"
        required: false
        default: "3"

permissions:
  contents: write

concurrency:
  group: preload-generator
  cancel-in-progress: true

jobs:
  build-and-upload:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-24.04-amd64
            runner: ubuntu-24.04
          - name: ubuntu-24.04-arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    env:
      RELEASE_TAG: ${{ github.event.inputs.release_tag || 'latest' }}
      MINIKUBE_REF: ${{ github.event.inputs.minikube_ref || 'HEAD' }}
      PRELOAD_LIMIT: ${{ github.event.inputs.limit || '3' }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout minikube-preloads
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Generate preloads and upload release assets
        run: make release-preloads-github
